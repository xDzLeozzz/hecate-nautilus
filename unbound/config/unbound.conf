# Hecate-Nautilus: Unbound Configuration vFinal
server:
    # --- Configurações Gerais ---
    # Roda em primeiro plano, essencial para contêineres Docker
    do-daemonize: no
    # Define o usuário para o qual o processo irá dropar privilégios
    username: "unbound"
    # Diretório de trabalho dentro do contêiner
    directory: "/etc/unbound/"
    # Nível de log (1 é o padrão, aumente para depuração)
    log-level: 1
    # Desativa logs de queries e respostas para máxima performance
    log-queries: no
    log-replies: no
    
    # --- Interface de Rede ---
    # Ouve apenas em localhost na porta 5335 para ser usado pelo AdGuard
    interface: 127.0.0.1@5335
    access-control: 127.0.0.1/32 allow

    # --- Otimizações de Performance Extrema ---
    # Alinhado com os 14 núcleos físicos do Xeon E5-2v80v4
    num-threads: 14
    # Slabs devem ser potência de 2, próximo ao num-threads
    msg-cache-slabs: 16
    rrset-cache-slabs: 16
    infra-cache-slabs: 16
    key-cache-slabs: 16
    # Alocação de memória para cache. Com 16GB de RAM, estes valores são seguros.
    rrset-cache-size: 4g
    msg-cache-size: 2g
    # Aumenta os buffers de socket de rede
    so-rcvbuf: 8m
    so-sndbuf: 8m
    # Aumenta o número de queries simultâneas para lidar com picos de tráfego
    outgoing-range: 8192
    num-queries-per-thread: 4096

    # --- Otimizações de Latência ---
    # Mantém itens populares no cache, atualizando-os antes de expirarem
    prefetch: yes
    prefetch-key: yes
    # Entrega um resultado expirado do cache imediatamente enquanto busca o novo
    serve-expired: yes

    # --- Privacidade e Segurança ---
    hide-identity: yes
    hide-version: yes
    harden-glue: yes
    harden-dnssec-stripped: yes
    use-caps-for-id: yes
    # Envia apenas a parte necessária do domínio para cada servidor DNS
    qname-minimisation: yes
    # Caminho para o arquivo com as chaves raiz do DNSSEC
    auto-trust-anchor-file: "/etc/unbound/root.key"

    # --- Interface de Estatísticas e Controle ---
    # Habilita a coleta de métricas a cada 60 segundos
    statistics-interval: 60
    # Não acumula as estatísticas a cada intervalo
    statistics-cumulative: no
    # Habilita o controle remoto para healthchecks e stats
    control-enable: yes
    # Permite que o unbound-control (no mesmo host) acesse as estatísticas
    control-interface: 127.0.0.1
    control-port: 8953